<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تخفيضات صابر - متجر رقمي</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #3B82F6; /* Tailwind blue-500 */
            --secondary-color: #10B981; /* Tailwind emerald-500 */
            --accent-color: #F59E0B; /* Tailwind amber-500 */
            --light-color: #F9FAFB; /* Tailwind gray-50 */
            --dark-color: #1F2937; /* Tailwind gray-800 */
            --text-light: #F3F4F6; /* Tailwind gray-100 */
            --text-dark: #374151; /* Tailwind gray-700 */
            --danger-color: #EF4444; /* Tailwind red-500 */
            --font-family-primary: 'Tajawal', sans-serif;
            --font-family-secondary: 'Almarai', sans-serif;
        }

        body {
            font-family: var(--font-family-primary);
            background-color: var(--light-color);
            color: var(--text-dark);
            line-height: 1.7;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--light-color);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--light-color);
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #2563EB; 
        }

        .logo-font {
            font-family: var(--font-family-secondary);
        }

        .product-card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.1);
        }
        
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .cart-panel {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background-color: var(--dark-color);
            color: var(--text-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            visibility: hidden;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        .toast.success {
            background-color: var(--secondary-color);
        }
        .toast.error {
            background-color: var(--danger-color);
        }
        .product-image-clickable, .product-name-clickable {
            cursor: pointer;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" id="home-link" class="text-3xl font-bold logo-font text-blue-600">تخفيضات صابر<i class="fas fa-tags ml-2 text-green-500"></i></a>
            <nav class="hidden md:flex items-center space-x-reverse space-x-6">
                <a href="#" id="nav-home" class="text-gray-600 hover:text-blue-600 transition duration-300">الرئيسية</a>
                <a href="#products-section-nav" id="nav-products" class="text-gray-600 hover:text-blue-600 transition duration-300">المنتجات</a>
                <a href="#" id="nav-offers" class="text-gray-600 hover:text-blue-600 transition duration-300">العروض</a>
                <a href="#" id="nav-about" class="text-gray-600 hover:text-blue-600 transition duration-300">من نحن</a>
            </nav>
            <div class="flex items-center space-x-reverse space-x-4">
                <button id="cart-button" class="relative text-gray-700 hover:text-blue-600 transition duration-300">
                    <i class="fas fa-shopping-cart text-2xl"></i>
                    <span id="cart-item-count" class="badge hidden">0</span>
                </button>
                <button id="menu-button" class="md:hidden text-gray-700 hover:text-blue-600">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="md:hidden bg-white shadow-lg absolute top-full left-0 right-0 hidden">
            <a href="#" id="mobile-nav-home" class="block px-4 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition duration-300">الرئيسية</a>
            <a href="#products-section-nav" id="mobile-nav-products" class="block px-4 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition duration-300">المنتجات</a>
            <a href="#" id="mobile-nav-offers" class="block px-4 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition duration-300">العروض</a>
            <a href="#" id="mobile-nav-about" class="block px-4 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition duration-300">من نحن</a>
        </div>
    </header>

    <main id="main-content" class="container mx-auto px-4 py-8">
        <section id="hero-section" class="bg-gradient-to-br from-blue-500 to-green-400 text-white p-8 md:p-16 rounded-xl shadow-2xl mb-12 text-center">
            <h1 class="text-4xl md:text-5xl font-bold logo-font mb-6">مرحباً بك في تخفيضات صابر!</h1>
            <p class="text-lg md:text-xl mb-8 max-w-2xl mx-auto">أفضل المنتجات الرقمية والعروض الحصرية بأسعار لا تقاوم.</p>
            <a href="#products-section" class="bg-white text-blue-600 hover:bg-gray-100 font-semibold py-3 px-8 rounded-lg shadow-md transition duration-300 transform hover:scale-105 text-lg">
                اكتشف المنتجات <i class="fas fa-arrow-left mr-2"></i>
            </a>
        </section>

        <section id="products-section">
            <h2 class="text-3xl font-bold text-center mb-10 logo-font text-gray-800 relative pb-3">
                أحدث المنتجات
                <span class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-24 h-1 bg-gradient-to-r from-blue-500 to-green-500 rounded"></span>
            </h2>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <div class="flex justify-center items-center col-span-full h-64">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </section>
    </main>

    <div id="product-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl transform scale-95 -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-product-name" class="text-2xl font-bold logo-font text-blue-600"></h3>
                <button id="close-modal-button" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div class="md:flex md:space-x-reverse md:space-x-6">
                <img id="modal-product-image" src="1.png" alt="Product Image" class="w-full md:w-1/2 h-64 object-cover rounded-lg mb-4 md:mb-0" onerror="this.onerror=null;this.src='https://placehold.co/600x400/E2E8F0/AAAAAA?text=صورة+غير+متوفرة';">
                <div class="md:w-1/2">
                    <p id="modal-product-description" class="text-gray-700 mb-4"></p>
                    <div class="mb-4">
                        <span id="modal-product-price" class="text-3xl font-bold text-green-500"></span>
                        <span id="modal-product-original-price" class="text-gray-500 line-through ml-2 text-lg"></span>
                    </div>
                    <div class="flex items-center mb-6">
                        <label for="modal-quantity" class="ml-2 font-semibold">الكمية:</label>
                        <input type="number" id="modal-quantity" value="1" min="1" class="w-20 border border-gray-300 rounded-md p-2 text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="modal-add-to-cart-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 flex items-center justify-center">
                        <i class="fas fa-cart-plus mr-2"></i> إضافة إلى السلة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-panel" class="cart-panel fixed top-0 left-0 h-full w-full md:w-96 bg-white shadow-2xl p-6 transform -translate-x-full z-[150] overflow-y-auto">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h3 class="text-2xl font-bold logo-font text-blue-600">سلة التسوق</h3>
            <button id="close-cart-button" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
        </div>
        <div id="cart-items-container" class="space-y-4 mb-6">
            <p id="empty-cart-message" class="text-gray-500 text-center py-8">سلة التسوق فارغة حالياً.</p>
        </div>
        <div id="cart-summary" class="border-t border-gray-200 pt-6 hidden">
            <div class="flex justify-between items-center mb-3">
                <span class="text-lg font-semibold">الإجمالي الفرعي:</span>
                <span id="cart-subtotal" class="text-lg font-bold text-gray-800">$0.00</span>
            </div>
            <p class="text-sm text-gray-500 mb-4">سيتم التواصل معك لتأكيد الطلب وتفاصيل الشحن.</p>
            <button id="checkout-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 flex items-center justify-center">
                <i class="fab fa-whatsapp mr-2"></i> إرسال الطلب عبر واتساب
            </button>
        </div>
    </div>
    
    <div id="toast-notification" class="toast">
        <span id="toast-message"></span>
    </div>

    <footer class="bg-gray-800 text-gray-300 py-12 mt-16">
        <div class="container mx-auto px-4 text-center">
            <p class="logo-font text-2xl mb-4">&copy; 2025 تخفيضات صابر. جميع الحقوق محفوظة.</p>
            <div class="space-x-reverse space-x-4 mb-4">
                <a href="#" class="hover:text-blue-400 transition duration-300">سياسة الخصوصية</a>
                <a href="#" class="hover:text-blue-400 transition duration-300">شروط الخدمة</a>
            </div>
            <div class="flex justify-center space-x-reverse space-x-5 text-xl">
                <a href="https://wa.me/967782343232" target="_blank" class="hover:text-green-400 transition duration-300"><i class="fab fa-whatsapp"></i></a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            deleteDoc, 
            collection, 
            onSnapshot,
            runTransaction,
            updateDoc, 
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let userId = null; 
        let globalCartItems = []; 

        const productList = document.getElementById('product-list');
        const cartButton = document.getElementById('cart-button');
        const cartPanel = document.getElementById('cart-panel');
        const closeCartButton = document.getElementById('close-cart-button');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartItemCount = document.getElementById('cart-item-count');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSummary = document.getElementById('cart-summary');
        const cartSubtotal = document.getElementById('cart-subtotal');
        const checkoutButton = document.getElementById('checkout-button'); 
        
        const modal = document.getElementById('product-detail-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductImage = document.getElementById('modal-product-image');
        const modalProductDescription = document.getElementById('modal-product-description');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalProductOriginalPrice = document.getElementById('modal-product-original-price');
        const modalQuantityInput = document.getElementById('modal-quantity');
        const modalAddToCartButton = document.getElementById('modal-add-to-cart-button');
        let currentModalProductId = null;

        const menuButton = document.getElementById('menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        const toastNotification = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        let toastTimeout;

        const products = [
            { id: 'prod_001', name: 'برنامج تحرير صور احترافي', description: 'أطلق العنان لإبداعك مع أقوى برنامج لتحرير الصور وتصميم الجرافيك. مزايا متقدمة وواجهة سهلة الاستخدام.', price: 79.99, originalPrice: 99.99, image: '1.png', category: 'برامج' },
            { id: 'prod_002', name: 'دورة تطوير ويب شاملة', description: 'تعلم تطوير الويب من الصفر إلى الاحتراف. HTML, CSS, JavaScript, Node.js, React والمزيد. شهادة معتمدة.', price: 149.50, image: '2.png', category: 'دورات' },
            { id: 'prod_003', name: 'قالب موقع شركة عصري', description: 'قالب HTML/CSS متجاوب بالكامل، مثالي للشركات الناشئة والصغيرة. تصميم أنيق وسهل التخصيص.', price: 25.00, originalPrice: 40.00, image: '3.png', category: 'قوالب' },
            { id: 'prod_004', name: 'مجموعة أيقونات فلات', description: 'أكثر من 1000 أيقونة فلات عالية الجودة بصيغ SVG و PNG. مثالية لمشاريع التصميم والويب.', price: 19.99, image: '4.png', category: 'تصميم' },
            { id: 'prod_005', name: 'استضافة ويب سريعة', description: 'خطة استضافة ويب ممتازة مع مساحة تخزين SSD غير محدودة ودعم فني 24/7. ضمان استعادة الأموال.', price: 9.99, originalPrice: 15.00, image: '5.png', category: 'خدمات' },
            { id: 'prod_006', name: 'كتاب التسويق الرقمي', description: 'دليلك الشامل لأسرار التسويق الرقمي الناجح. استراتيجيات فعالة لزيادة مبيعاتك وجمهورك.', price: 35.00, image: '6.png', category: 'كتب' },
        ];

        function showToast(message, type = 'info', duration = 3000) {
            toastMessage.textContent = message;
            toastNotification.className = 'toast show'; 
            if (type === 'success') {
                toastNotification.classList.add('success');
            } else if (type === 'error') {
                toastNotification.classList.add('error');
            }
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toastNotification.classList.remove('show');
            }, duration);
        }

        // --- Authentication (Revised) ---
        let authInitializationAttempted = false;
        const authReadyPromise = new Promise((resolve, reject) => {
            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase Auth: User signed in/state changed. UID:", userId);
                    loadCart(); // Load cart as soon as user (even anonymous) is confirmed
                    unsubscribe(); // Important: Unsubscribe after first successful user confirmation
                    resolve(userId);
                } else if (!authInitializationAttempted) {
                    authInitializationAttempted = true; 
                    console.log("Firebase Auth: No user, attempting initial sign-in...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            // onAuthStateChanged will fire again with the user, resolving the promise.
                        } else {
                            await signInAnonymously(auth);
                            // onAuthStateChanged will fire again with the user, resolving the promise.
                        }
                    } catch (error) {
                        console.error("Firebase Auth: Initial sign-in attempt failed:", error);
                        showToast("فشل في المصادقة الأولية. السلة قد لا تعمل.", "error");
                        unsubscribe(); 
                        reject(error); 
                    }
                } else {
                    // This case implies a sign-out or persistent failure after the initial attempt.
                    // For a no-login store, this state means cart won't work.
                    console.log("Firebase Auth: User became null after initial auth process or failed attempt.");
                    userId = null;
                    clearCartUI();
                    // We don't reject the promise here again if it was already rejected or resolved.
                    // If it resolved and then user became null, it's a state change, not an init failure.
                }
            }, (error) => { 
                console.error("Firebase Auth: onAuthStateChanged listener error:", error);
                unsubscribe();
                reject(error);
            });
        });

        async function initializeAuthentication() {
            try {
                await authReadyPromise; // Wait for the promise to resolve or reject
                console.log("Authentication initialized. User ID:", userId ? userId : "Not available");
            } catch (error) {
                // Error already logged and toast shown by the promise rejection logic
                console.error("Failed to complete initial authentication steps:", error);
            }
        }


        function renderProducts() {
            productList.innerHTML = ''; 
            if (!products || products.length === 0) {
                productList.innerHTML = '<p class="col-span-full text-center text-gray-500">لا توجد منتجات لعرضها حالياً.</p>';
                return;
            }
            products.forEach(product => {
                const discountPercentage = product.originalPrice ? Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
                const productCardHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 product-card-hover flex flex-col">
                        ${discountPercentage > 0 ? `<div class="absolute top-3 left-3 bg-red-500 text-white text-xs font-semibold px-3 py-1 rounded-full z-10">خصم ${discountPercentage}%</div>` : ''}
                        <div class="h-56 overflow-hidden product-image-clickable" data-product-id="${product.id}">
                            <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-110" onerror="this.onerror=null;this.src='https://placehold.co/600x400/E2E8F0/AAAAAA?text=صورة+غير+متوفرة';">
                        </div>
                        <div class="p-5 flex flex-col flex-grow">
                            <h3 class="text-xl font-bold mb-2 text-gray-800 truncate product-name-clickable" title="${product.name}" data-product-id="${product.id}">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-3 flex-grow">${product.description.substring(0, 70)}...</p>
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-2xl font-extrabold text-green-500">$${product.price.toFixed(2)}</p>
                                ${product.originalPrice ? `<p class="text-sm text-gray-400 line-through">$${product.originalPrice.toFixed(2)}</p>` : ''}
                            </div>
                            <button data-product-id="${product.id}" class="add-to-cart-from-card-button w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md transition duration-300 flex items-center justify-center text-sm">
                                <i class="fas fa-cart-plus mr-2"></i> أضف للسلة
                            </button>
                        </div>
                    </div>
                `;
                productList.insertAdjacentHTML('beforeend', productCardHTML);
            });

            document.querySelectorAll('.add-to-cart-from-card-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    addItemToCart(e.currentTarget.dataset.productId, 1);
                });
            });
            document.querySelectorAll('.product-image-clickable, .product-name-clickable').forEach(element => {
                element.addEventListener('click', (e) => {
                    openProductModal(e.currentTarget.dataset.productId);
                });
            });
        }
        
        function openProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            currentModalProductId = productId;
            modalProductName.textContent = product.name;
            modalProductImage.src = product.image; 
            modalProductImage.alt = product.name;
            modalProductDescription.textContent = product.description;
            modalProductPrice.textContent = `$${product.price.toFixed(2)}`;
            if (product.originalPrice) {
                modalProductOriginalPrice.textContent = `$${product.originalPrice.toFixed(2)}`;
                modalProductOriginalPrice.classList.remove('hidden');
            } else {
                modalProductOriginalPrice.classList.add('hidden');
            }
            modalQuantityInput.value = 1;
            modal.classList.add('active');
        }

        closeModalButton.addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', (e) => { 
            if (e.target === modal) modal.classList.remove('active');
        });

        modalAddToCartButton.addEventListener('click', () => {
            if (currentModalProductId) {
                const quantity = parseInt(modalQuantityInput.value);
                if (quantity > 0) {
                    addItemToCart(currentModalProductId, quantity);
                    modal.classList.remove('active');
                } else {
                    showToast("الرجاء إدخال كمية صحيحة.", "error");
                }
            }
        });

        async function addItemToCart(productId, quantity = 1) {
            if (!userId) {
                showToast("خطأ في المصادقة. لا يمكن إضافة المنتج. يرجى تحديث الصفحة أو المحاولة لاحقاً.", "error");
                console.error("addItemToCart: userId is null. Authentication might have failed or is not complete.");
                return; 
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                showToast("المنتج غير موجود.", "error");
                return;
            }

            const cartItemRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, productId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const cartItemDoc = await transaction.get(cartItemRef);
                    if (!cartItemDoc.exists()) {
                        transaction.set(cartItemRef, {
                            name: product.name,
                            price: product.price,
                            image: product.image, 
                            quantity: quantity,
                            addedAt: serverTimestamp()
                        });
                    } else {
                        const newQuantity = cartItemDoc.data().quantity + quantity;
                        transaction.update(cartItemRef, { quantity: newQuantity });
                    }
                });
                showToast(`تمت إضافة "${product.name}" إلى السلة!`, "success");
            } catch (error) {
                console.error("Error adding item to cart: ", error);
                showToast("خطأ أثناء إضافة المنتج للسلة.", "error");
            }
        }

        async function updateCartItemQuantity(productId, newQuantity) {
            if (!userId) return;
            if (newQuantity < 1) {
                await removeItemFromCart(productId);
                return;
            }
            const cartItemRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, productId);
            try {
                await updateDoc(cartItemRef, { quantity: newQuantity });
                showToast("تم تحديث كمية المنتج.", "success");
            } catch (error) {
                console.error("Error updating cart item quantity: ", error);
                showToast("خطأ في تحديث الكمية.", "error");
            }
        }
        
        async function removeItemFromCart(productId) {
            if (!userId) return;
            const cartItemRef = doc(db, `artifacts/${appId}/users/${userId}/cart`, productId);
            try {
                await deleteDoc(cartItemRef);
                showToast("تم إزالة المنتج من السلة.", "info");
            } catch (error) {
                console.error("Error removing item from cart: ", error);
                showToast("خطأ في إزالة المنتج.", "error");
            }
        }
        
        function clearCartUI() {
            cartItemsContainer.innerHTML = '';
            globalCartItems = [];
            emptyCartMessage.classList.remove('hidden');
            cartSummary.classList.add('hidden');
            cartItemCount.textContent = '0';
            cartItemCount.classList.add('hidden');
        }

        function loadCart() {
            if (!userId) {
                console.log("loadCart: No userId, cannot load cart.");
                clearCartUI();
                return;
            }
            
            const cartColRef = collection(db, `artifacts/${appId}/users/${userId}/cart`);
            onSnapshot(cartColRef, (snapshot) => {
                globalCartItems = []; 
                snapshot.forEach((doc) => {
                    globalCartItems.push({ id: doc.id, ...doc.data() });
                });
                renderCart(globalCartItems);
            }, (error) => {
                console.error("Error loading cart from Firestore: ", error);
                showToast("حدث خطأ أثناء تحميل السلة.", "error");
                clearCartUI(); 
            });
        }

        function renderCart(cartItems) {
            cartItemsContainer.innerHTML = '';
            let subtotal = 0;
            let totalItems = 0;

            if (cartItems.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                cartSummary.classList.add('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cartSummary.classList.remove('hidden');
                
                cartItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center space-x-reverse space-x-3 p-3 border-b border-gray-100';
                    itemElement.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/E2E8F0/AAAAAA?text=صورة';">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-sm truncate" title="${item.name}">${item.name}</h4>
                            <p class="text-xs text-gray-500">$${item.price.toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center">
                            <input type="number" value="${item.quantity}" min="1" data-id="${item.id}" class="cart-item-quantity w-12 border border-gray-300 rounded-md p-1 text-center text-sm mx-2">
                            <p class="font-semibold text-gray-700 text-sm w-16 text-left">$${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                        <button data-id="${item.id}" class="remove-cart-item text-red-500 hover:text-red-700 transition duration-300 text-lg">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                    subtotal += item.price * item.quantity;
                    totalItems += item.quantity;
                });
            }

            cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
            cartItemCount.textContent = totalItems;
            if (totalItems > 0) {
                cartItemCount.classList.remove('hidden');
            } else {
                cartItemCount.classList.add('hidden');
            }

            document.querySelectorAll('.cart-item-quantity').forEach(input => {
                input.addEventListener('change', (e) => { 
                    const newQuantity = parseInt(e.target.value);
                     if (newQuantity >= 1) {
                        updateCartItemQuantity(e.target.dataset.id, newQuantity);
                    } else {
                        e.target.value = 1; 
                        updateCartItemQuantity(e.target.dataset.id, 1);
                        showToast("الكمية يجب أن تكون 1 على الأقل.", "error");
                    }
                });
            });
            document.querySelectorAll('.remove-cart-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    removeItemFromCart(e.currentTarget.dataset.id);
                });
            });
        }

        checkoutButton.addEventListener('click', () => {
            if (globalCartItems.length === 0) {
                showToast("سلة التسوق فارغة!", "error");
                return;
            }

            let message = "مرحباً تخفيضات صابر،\n\nأرغب في طلب المنتجات التالية:\n\n";
            let subtotalForMessage = 0;

            globalCartItems.forEach(item => {
                message += `📦 *${item.name}*\n`;
                message += `   - الكمية: ${item.quantity}\n`;
                message += `   - السعر للقطعة: $${item.price.toFixed(2)}\n`;
                message += `   - الإجمالي للمنتج: $${(item.price * item.quantity).toFixed(2)}\n\n`;
                subtotalForMessage += item.price * item.quantity;
            });
            
            message += "--------------------\n";
            message += `💰 *الإجمالي الكلي للطلب: $${subtotalForMessage.toFixed(2)}*\n\n`;
            message += "يرجى تأكيد الطلب وتزويدي بتفاصيل الدفع والشحن.\n\n";
            message += "شكراً لك!";

            const whatsappUrl = `https://wa.me/967782343232?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showToast("يتم تحويلك إلى واتساب لإكمال الطلب...", "success");
        });

        cartButton.addEventListener('click', () => {
            cartPanel.classList.remove('-translate-x-full');
            cartPanel.classList.add('translate-x-0');
        });
        closeCartButton.addEventListener('click', () => {
            cartPanel.classList.add('-translate-x-full');
            cartPanel.classList.remove('translate-x-0');
        });
        
        menuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                if (this.hash !== "") {
                    const targetElement = document.querySelector(this.hash === '#products-section-nav' ? '#products-section' : this.hash);
                    if (targetElement) {
                        e.preventDefault(); 
                        targetElement.scrollIntoView({
                            behavior: 'smooth'
                        });
                        if (this.closest('#mobile-menu')) {
                           mobileMenu.classList.add('hidden');
                        }
                    }
                }
            });
        });
        
        document.getElementById('home-link').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('hero-section').scrollIntoView({ behavior: 'smooth' });
        });
         document.getElementById('nav-home').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('hero-section').scrollIntoView({ behavior: 'smooth' });
        });
         document.getElementById('mobile-nav-home').addEventListener('click', (e) => {
            e.preventDefault();
            mobileMenu.classList.add('hidden');
            document.getElementById('hero-section').scrollIntoView({ behavior: 'smooth' });
        });

        // --- Initialization ---
        async function initializeAppCore() {
            // Initialize authentication and wait for it to complete
            await initializeAuthentication(); 
            
            // Render products after authentication is ready (or has attempted and potentially failed)
            // This ensures that if auth fails, we still try to show products,
            // but cart operations will be blocked by the !userId check in addItemToCart
            renderProducts(); 
            
            // loadCart() is called from within the onAuthStateChanged logic in initializeAuthentication
            // once a user (anonymous or otherwise) is confirmed.
        }

        initializeAppCore();

    </script>
</body>
</html>
