<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الأنيق</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script type="module">
        // استيراد دوال Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, writeBatch, query, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- أيقونات SVG ---
        const ICONS = {
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
            shoppingCart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>`,
            user: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
            plusCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>`,
            minusCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>`,
            arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>`,
            star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`,
            tag: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`,
            externalLink: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>`,
            menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`,
            zap: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`,
            loader2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
            checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            messageSquare: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
            percent: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>`,
            eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            dollarSign: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
            mail: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>`,
            arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
            chevronUp: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>`,
        };
        
        function getIcon(name, size = 20, classes = "") {
            const svgString = ICONS[name] || ICONS.x; // Fallback to X icon
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, "image/svg+xml");
            const svgElement = svgDoc.documentElement;
            svgElement.setAttribute("width", size);
            svgElement.setAttribute("height", size);
            if (classes) {
                svgElement.classList.add(...classes.split(' '));
            }
            return svgElement.outerHTML;
        }

        // --- إعدادات Firebase ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_AUTH_DOMAIN_HERE", 
            projectId: "YOUR_PROJECT_ID_HERE", 
            storageBucket: "YOUR_STORAGE_BUCKET_HERE", 
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE", 
            appId: "YOUR_APP_ID_HERE" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-digital-store-ar-html-fastload';

        // تهيئة Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- بيانات المنتجات الأولية ---
        const initialProductsData = [
          { id: "prod_ar_01", name: "مجموعة أيقونات فلات عصرية (عرض خاص!)", price: 9.99, originalPrice: 15.99, imageUrl: "https://placehold.co/400x300/6366f1/e0e7ff?text=أيقونات+فلات+عرض", description: "أكثر من 500 أيقونة فيكتور مسطحة (Flat Design) عالية الجودة، مثالية لتطبيقات الويب والهواتف الذكية. تشمل ملفات SVG و PNG. احصل عليها الآن بسعر مخفض! هذه الأيقونات تتميز بتصميمها النظيف والبسيط، مما يجعلها مناسبة لمختلف أنواع المشاريع الرقمية الحديثة. سهلة التعديل والتخصيص لتناسب هوية علامتك التجارية.", category: "أصول تصميم", tags: ["أيقونات", "فيكتور", "تصميم مسطح", "واجهة مستخدم", "عرض"], rating: 4.9, onSale: true },
          { id: "prod_ar_02", name: "دورة برمجة تطبيقات الويب الشاملة (Full-Stack)", price: 120.00, imageUrl: "https://placehold.co/400x300/ec4899/fbcfe8?text=دورة+برمجة+ويب", description: "تعلم بناء تطبيقات ويب متكاملة من الصفر باستخدام أحدث التقنيات مثل React، Node.js، و MongoDB. تتضمن مشاريع عملية ودعمًا مستمرًا من مدربين خبراء. الدورة مصممة لتأخذك من مستوى المبتدئ إلى مستوى متقدم يمكنك من خلاله بناء تطبيقات ويب قوية وقابلة للتطوير.", category: "دورات تدريبية", tags: ["برمجة", "تطوير ويب", "React", "Node.js", "Full-Stack"], rating: 4.7 },
          { id: "prod_ar_03", name: "قالب بوربوينت احترافي (خصم 30%)", price: 15.75, originalPrice: 22.50, imageUrl: "https://placehold.co/400x300/f59e0b/fef3c7?text=قالب+بوربوينت+خصم", description: "مجموعة من 50 شريحة بوربوينت مصممة بشكل احترافي وجذاب، قابلة للتعديل بالكامل. مثالية لعروض الشركات والتقارير والمشاريع. استفد من الخصم الآن! يتميز القالب بتصاميم متنوعة تناسب مختلف المجالات، مع رسوم بيانية وجداول وأشكال قابلة للتخصيص بسهولة.", category: "قوالب عروض تقديمية", tags: ["بوربوينت", "عروض تقديمية", "أعمال", "قوالب", "تخفيض"], rating: 4.6, onSale: true },
          { id: "prod_ar_04", name: "كتاب إلكتروني: أسرار التسويق بالمحتوى الفعال", price: 9.99, imageUrl: "https://placehold.co/400x300/10b981/a7f3d0?text=كتاب+تسويق+محتوى", description: "دليل شامل لاستراتيجيات التسويق بالمحتوى التي تحقق نتائج. تعلم كيف تنشئ محتوى يجذب جمهورك المستهدف ويحولهم إلى عملاء. يغطي الكتاب كيفية تحديد الجمهور، وإنشاء أنواع مختلفة من المحتوى، وتوزيعه، وقياس أدائه.", category: "كتب إلكترونية", tags: ["تسويق بالمحتوى", "كتاب إلكتروني", "استراتيجيات تسويق"], rating: 4.8 },
          { id: "prod_ar_05", name: "حزمة مؤثرات صوتية سينمائية (SFX) - الأفضل مبيعًا", price: 35.00, imageUrl: "https://placehold.co/400x300/8b5cf6/ede9fe?text=مؤثرات+صوتية+SFX", description: "مكتبة ضخمة من المؤثرات الصوتية عالية الجودة للمونتاج السينمائي وصناعة الأفلام والألعاب. تشمل أصوات انفجارات، انتقالات، أجواء، وغيرها الكثير. جميع المؤثرات مسجلة بجودة احترافية وجاهزة للاستخدام الفوري في مشاريعك.", category: "أصول صوتية", tags: ["مؤثرات صوتية", "SFX", "مونتاج", "ألعاب", "سينما"], rating: 4.9 },
          { id: "prod_ar_06", name: "برنامج إدارة المهام والإنتاجية (توفير كبير!)", price: 19.99, originalPrice: 29.99, imageUrl: "https://placehold.co/400x300/3b82f6/dbeafe?text=برنامج+إدارة+مهام+توفير", description: "أداة قوية لتنظيم مهامك ومشاريعك وزيادة إنتاجيتك. يتميز بواجهة سهلة الاستخدام وميزات متقدمة مثل تتبع الوقت، والتعاون الجماعي، وتقارير الأداء. عرض محدود لا تفوته!", category: "برامج إنتاجية", tags: ["إنتاجية", "إدارة مهام", "تنظيم", "برامج مكتبية", "عرض خاص"], rating: 4.5, onSale: true }
        ];
        
        // --- حالة التطبيق ---
        let currentView = 'home'; // عرض الصفحة الرئيسية بشكل افتراضي
        let selectedProduct = null;
        let allProducts = []; // ستبدأ فارغة ثم تملأ من Firebase أو initialProductsData
        let filteredProducts = [];
        let searchQuery = '';
        let isLoadingProducts = true; // لا يزال مفيدًا لإظهار مؤشرات تحميل دقيقة
        let isCartLoading = true;
        let error = null;
        let cart = { items: [], totalAmount: 0, totalItems: 0 };
        let userId = null;
        let unsubscribeCartListener = null;

        // --- دوال المساعدة ---
        function navigateTo(view, product = null) {
            currentView = view;
            selectedProduct = product;
            renderApp();
            window.scrollTo(0, 0);
        }

        function createStyledButton(text, onClick, { variant = 'primary', className = '', iconName, disabled = false, type = "button", size = "normal" } = {}) {
            const button = document.createElement('button');
            button.type = type;
            button.disabled = disabled;
            const baseStyle = "font-semibold rounded-lg transition-all duration-300 ease-in-out flex items-center justify-center shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-opacity-50 disabled:opacity-60 disabled:cursor-not-allowed";
            let sizeStyle = "py-2.5 px-6"; 
            if (size === "small") sizeStyle = "py-2 px-4 text-sm";
            if (size === "large") sizeStyle = "py-3.5 px-8 text-lg";
            let variantStyle = '';
            switch (variant) {
                case 'primary': variantStyle = 'bg-sky-500 hover:bg-sky-600 text-white focus:ring-sky-400'; break;
                case 'secondary': variantStyle = 'bg-slate-600 hover:bg-slate-500 text-white focus:ring-slate-400'; break;
                case 'danger': variantStyle = 'bg-red-500 hover:bg-red-600 text-white focus:ring-red-400'; break;
                case 'success': variantStyle = 'bg-green-500 hover:bg-green-600 text-white focus:ring-green-400'; break;
                case 'whatsapp': variantStyle = 'bg-green-500 hover:bg-green-600 text-white focus:ring-green-400'; break;
                case 'warning': variantStyle = 'bg-yellow-500 hover:bg-yellow-600 text-black focus:ring-yellow-400'; break;
                case 'purple': variantStyle = 'bg-purple-600 hover:bg-purple-700 text-white focus:ring-purple-400'; break;
                case 'teal': variantStyle = 'bg-teal-500 hover:bg-teal-600 text-white focus:ring-teal-400'; break;
                case 'outline-light': variantStyle = 'bg-transparent border-2 border-slate-500 text-slate-300 hover:bg-slate-700 hover:text-white focus:ring-slate-400'; break;
                case 'outline-sky': variantStyle = 'bg-transparent border-2 border-sky-500 text-sky-400 hover:bg-sky-500 hover:text-white focus:ring-sky-400'; break;
                default: variantStyle = 'bg-sky-500 hover:bg-sky-600 text-white focus:ring-sky-400';
            }
            button.className = `${baseStyle} ${sizeStyle} ${variantStyle} ${className}`;
            let contentHTML = '';
            if (iconName) { contentHTML += `<span class="${text ? 'me-2' : ''}">${getIcon(iconName, size === "small" ? 16 : 20)}</span>`; }
            if (text) { contentHTML += `<span>${text}</span>`; }
            button.innerHTML = contentHTML;
            if (onClick) { button.addEventListener('click', onClick); }
            return button;
        }
        
        // --- دوال Firebase ---
        async function seedProducts() {
            const productsCollectionRef = collection(db, `/artifacts/${appId}/public/data/products_ar`);
            const q = query(productsCollectionRef);
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("مجموعة المنتجات فارغة. جاري إضافة المنتجات الأولية...");
                const batch = writeBatch(db);
                initialProductsData.forEach(product => {
                    const docRef = doc(productsCollectionRef, product.id);
                    batch.set(docRef, product);
                });
                await batch.commit();
                console.log("تمت إضافة المنتجات الأولية.");
            } else {
                console.log("مجموعة المنتجات تحتوي بالفعل على بيانات.");
            }
        }

        async function fetchProducts() {
            isLoadingProducts = true;
            error = null;
            // لا نستدعي renderApp() هنا مباشرة، دع الواجهة الحالية تستمر
            try {
                await seedProducts();
                const productsCollectionRef = collection(db, `/artifacts/${appId}/public/data/products_ar`);
                const productSnapshot = await getDocs(query(productsCollectionRef));
                
                if (!productSnapshot.empty) {
                    allProducts = productSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else if (initialProductsData.length > 0) {
                     console.warn("مجموعة منتجات Firestore فارغة، سيتم استخدام البيانات الأولية.");
                    allProducts = [...initialProductsData];
                } else {
                    console.error("لا توجد منتجات متاحة من Firestore أو البيانات الأولية.");
                    allProducts = []; // ضمان أن allProducts ليست undefined
                }
                filterProducts();
            } catch (err) {
                console.error("خطأ في جلب المنتجات:", err);
                if (err.code === 'permission-denied') {
                    error = "فشل تحميل المنتجات: لا توجد صلاحية للوصول إلى قاعدة البيانات.";
                } else {
                    error = "فشل تحميل المنتجات. يرجى محاولة تحديث الصفحة.";
                }
                allProducts = [...initialProductsData]; // استخدام البيانات الأولية كاحتياطي عند الخطأ
                filterProducts();
            } finally {
                isLoadingProducts = false;
                renderApp(); // عرض البيانات المجلوبة أو الاحتياطية
            }
        }
        
        function filterProducts() {
            const sourceProducts = allProducts.length > 0 ? allProducts : initialProductsData;
            if (searchQuery === '') {
                filteredProducts = [...sourceProducts];
            } else {
                const lowerSearchQuery = searchQuery.toLowerCase();
                filteredProducts = sourceProducts.filter(product =>
                    product.name?.toLowerCase().includes(lowerSearchQuery) ||
                    product.description?.toLowerCase().includes(lowerSearchQuery) ||
                    product.category?.toLowerCase().includes(lowerSearchQuery) ||
                    (product.tags && product.tags.some(tag => tag.toLowerCase().includes(lowerSearchQuery)))
                );
            }
        }

        // --- دوال السلة (تبقى كما هي إلى حد كبير) ---
        function calculateCartTotals(items) {
            const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            return { items, totalAmount: parseFloat(totalAmount.toFixed(2)), totalItems };
        }

        async function updateFirestoreCart(newCartData) {
            if (userId) {
                const cartDocRef = doc(db, `/artifacts/${appId}/users/${userId}/cart/userCart_ar`);
                try { await setDoc(cartDocRef, newCartData); } 
                catch (error) { console.error("خطأ في تحديث سلة Firestore:", error); }
            }
        }

        function addToCart(product, quantity = 1) {
            const existingItemIndex = cart.items.findIndex(item => item.id === product.id);
            let updatedItems;
            if (existingItemIndex > -1) {
                updatedItems = cart.items.map((item, index) => index === existingItemIndex ? { ...item, quantity: item.quantity + quantity } : item);
            } else {
                updatedItems = [...cart.items, { ...product, quantity }];
            }
            const newCartData = calculateCartTotals(updatedItems); cart = newCartData; updateFirestoreCart(newCartData);
            renderNavbar(); 
            if(currentView === 'cart') renderCartView(); 
        }

        function removeFromCart(productId) {
            const updatedItems = cart.items.filter(item => item.id !== productId);
            const newCartData = calculateCartTotals(updatedItems); cart = newCartData; updateFirestoreCart(newCartData);
            renderNavbar();
            if(currentView === 'cart') renderCartView();
        }

        function updateQuantity(productId, newQuantity) {
            if (newQuantity < 1) { removeFromCart(productId); return; }
            const updatedItems = cart.items.map(item => item.id === productId ? { ...item, quantity: newQuantity } : item );
            const newCartData = calculateCartTotals(updatedItems); cart = newCartData; updateFirestoreCart(newCartData);
            renderNavbar();
            if(currentView === 'cart') renderCartView();
        }

        function clearCart() {
            const newCartData = { items: [], totalAmount: 0, totalItems: 0 }; cart = newCartData; updateFirestoreCart(newCartData);
            renderNavbar();
            if(currentView === 'cart' || currentView === 'checkout') { navigateTo('home'); }
        }
        
        // --- دوال العرض (Render Functions) ---
        function renderNavbar() {
            const navbarContainer = document.getElementById('navbar-container');
            if (!navbarContainer) return;
            const navLinks = [
                { view: 'home', label: 'الرئيسية' }, { view: 'products', label: 'المنتجات' },
                { view: 'about', label: 'من نحن' }, { view: 'faq', label: 'الأسئلة الشائعة' },
                { view: 'privacy', label: 'سياسة الخصوصية' }, { view: 'contact', label: 'اتصل بنا' },
            ];
            let mobileMenuOpen = false;
            const navHTML = `
                <nav class="bg-slate-800/80 backdrop-blur-md text-white p-4 sticky top-0 z-50 shadow-lg border-b border-slate-700">
                    <div class="container mx-auto flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-sky-400 cursor-pointer hover:text-sky-300 transition-colors flex items-center" id="nav-logo">
                            ${getIcon('zap', 28, 'me-2 text-yellow-400 transform -rotate-12')} المتجر الأنيق</h1>
                        <div class="hidden md:flex items-center bg-slate-700 rounded-full p-2 w-2/5 shadow-inner">
                            ${getIcon('search', 20, 'text-slate-400 ms-3')}
                            <input type="text" id="desktop-search-input" placeholder="ابحث عن تحفتك الرقمية..." class="bg-transparent focus:outline-none text-white w-full placeholder-slate-400 px-2" value="${searchQuery}"></div>
                        <div class="hidden md:flex items-center space-x-1 space-x-reverse">
                            ${navLinks.map(link => `<button data-view="${link.view}" class="nav-link hover:bg-slate-700 transition-colors px-3 py-2 rounded-md text-xs font-medium">${link.label}</button>`).join('')}
                            <button data-view="cart" class="nav-link relative bg-sky-500 hover:bg-sky-600 transition-colors flex items-center px-4 py-2 rounded-full text-sm font-medium shadow-md">
                                ${getIcon('shoppingCart', 18, 'me-1.5')} السلة
                                ${cart.totalItems > 0 ? `<span class="absolute -top-1 -right-1 bg-red-500 text-xs rounded-full h-5 w-5 flex items-center justify-center shadow-sm border-2 border-slate-800">${cart.totalItems}</span>` : ''}</button></div>
                        <div class="md:hidden flex items-center">
                            <button data-view="cart" class="nav-link relative hover:text-sky-400 transition-colors ms-4 p-2">${getIcon('shoppingCart', 24)} ${cart.totalItems > 0 ? `<span class="absolute -top-1 -left-1 bg-red-500 text-xs rounded-full h-4 w-4 flex items-center justify-center">${cart.totalItems}</span>` : ''}</button>
                            <button id="mobile-menu-button" class="text-white focus:outline-none p-2">${getIcon('menu', 28)}</button></div></div>
                    <div id="mobile-menu" class="hidden md:hidden mt-3 bg-slate-700/90 backdrop-blur-sm rounded-md shadow-xl py-2">
                        <div class="p-2 mx-2 mb-2"><input type="text" id="mobile-search-input" placeholder="ابحث..." class="bg-slate-600 focus:outline-none text-white w-full p-2 rounded-md" value="${searchQuery}"></div>
                        ${[...navLinks, {view: 'cart', label: 'السلة'}].map(item => `<button data-view="${item.view}" class="nav-link block w-full text-right px-4 py-2.5 hover:bg-slate-600 transition-colors">${item.label}</button>`).join('')}</div></nav>`;
            navbarContainer.innerHTML = navHTML;
            document.getElementById('nav-logo').addEventListener('click', () => navigateTo('home'));
            document.querySelectorAll('.nav-link').forEach(button => {
                button.addEventListener('click', (e) => {
                    const view = e.currentTarget.dataset.view; navigateTo(view);
                    if (mobileMenuOpen) { document.getElementById('mobile-menu').classList.add('hidden'); mobileMenuOpen = false; }
                });
            });
            const desktopSearchInput = document.getElementById('desktop-search-input');
            const mobileSearchInput = document.getElementById('mobile-search-input');
            const handleSearch = (e) => { searchQuery = e.target.value; filterProducts(); if (currentView === 'products' || currentView === 'home') renderApp(); };
            desktopSearchInput.addEventListener('input', handleSearch);
            mobileSearchInput.addEventListener('input', handleSearch);
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuButton.addEventListener('click', () => { mobileMenuOpen = !mobileMenuOpen; mobileMenu.classList.toggle('hidden'); });
        }

        function renderPromotionalBanner() {
            const productsToConsider = allProducts.length > 0 ? allProducts : initialProductsData;
            const saleProducts = productsToConsider.filter(p => p.onSale && p.originalPrice);
            if (saleProducts.length === 0) return '';
            const itemsHTML = saleProducts.map(product => `
                <div class="flex items-center cursor-pointer hover:opacity-80 transition-opacity promotional-item" data-product-id="${product.id}">
                    <img src="${product.imageUrl || 'https://placehold.co/50x50/ffffff/333333?text=عرض'}" alt="${product.name}" class="w-10 h-10 object-cover rounded-md me-3 border-2 border-white/50" onerror="this.src='https://placehold.co/50x50/ffffff/333333?text=خطأ'">
                    <div> <span class="font-semibold text-sm">${product.name}</span> <div class="flex items-baseline"> <span class="text-lg font-bold me-2">$${product.price.toFixed(2)}</span> <span class="text-xs line-through opacity-75">$${product.originalPrice.toFixed(2)}</span> </div> </div></div>`).join('');
            return `<div class="bg-gradient-to-r from-purple-600 via-pink-500 to-red-500 text-white py-3 px-4 shadow-lg"><div class="container mx-auto flex items-center justify-center overflow-hidden">
                        ${getIcon('percent', 28, 'me-3 flex-shrink-0 animate-pulse')}
                        <div class="marquee-container relative w-full overflow-hidden"><div class="marquee-content flex space-x-8 space-x-reverse animate-marquee whitespace-nowrap">${itemsHTML}${itemsHTML}</div></div></div></div>`;
        }
        
        function renderHero() {
            return `
                <div class="relative text-white py-24 md:py-40 px-4 overflow-hidden bg-slate-900">
                    <div class="absolute inset-0 z-0"><div class="absolute inset-0 bg-gradient-to-br from-sky-900 via-purple-900 to-slate-900 opacity-70"></div><div class="absolute inset-0 pattern-dots pattern-slate-700 pattern-bg-transparent pattern-opacity-10 pattern-size-6"></div></div>
                    <div class="absolute -top-20 -right-20 w-72 h-72 bg-sky-500/20 rounded-full filter blur-3xl opacity-50 animate-pulse-slow"></div><div class="absolute -bottom-20 -left-20 w-72 h-72 bg-purple-500/20 rounded-full filter blur-3xl opacity-50 animate-pulse-slower"></div>
                    <div class="container mx-auto text-center relative z-10">
                        <h1 class="text-5xl md:text-7xl font-extrabold mb-6 animate-fade-in-down tracking-tight leading-tight"><span class="block">متجرك الرقمي الجديد،</span><span class="block text-sky-400">بإمكانيات لا محدودة</span></h1>
                        <p class="text-lg md:text-xl text-slate-300 mb-10 animate-fade-in-up delay-200 max-w-2xl mx-auto leading-relaxed">اكتشف إبداعات رقمية فريدة، مصممة لإلهامك وتمكينك. مدعوم بالذكاء الاصطناعي لتعزيز تجربتك وتقديم الأفضل لك.</p>
                        <div id="hero-button-container"></div></div></div>`;
        }

        function renderProductCard(product) {
            const card = document.createElement('div');
            card.className = "bg-slate-800 rounded-xl shadow-2xl overflow-hidden flex flex-col justify-between transition-all duration-300 ease-in-out hover:shadow-sky-500/30 hover:scale-[1.03] border border-slate-700/50 group";
            const ratingStars = [...Array(5)].map((_, i) => `<span class="${i < Math.round(product.rating || 0) ? "text-yellow-400 fill-current" : "text-slate-600"}">${getIcon('star', 18)}</span>`).join('');
            card.innerHTML = `
                <div class="relative overflow-hidden cursor-pointer product-details-link" data-product-id="${product.id}">
                    <img src="${product.imageUrl || 'https://placehold.co/400x300/1a202c/718096?text=لا+توجد+صورة'}" alt="${product.name}" class="w-full h-56 object-cover transition-transform duration-300 group-hover:scale-110" onerror="this.src='https://placehold.co/400x300/1a202c/718096?text=خطأ+في+الصورة'}">
                    ${product.category ? `<span class="absolute top-3 left-3 bg-sky-500/80 text-white text-xs px-2.5 py-1 rounded-full backdrop-blur-sm shadow-sm">${product.category}</span>` : ''}
                    ${product.onSale && product.originalPrice ? `<div class="absolute top-3 right-3 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow-lg transform rotate-3">عرض!</div>` : ''}</div>
                <div class="p-5 flex flex-col flex-grow">
                    <h3 class="text-xl font-semibold text-sky-300 mb-2 h-14 overflow-hidden cursor-pointer hover:text-sky-200 product-details-link" data-product-id="${product.id}">${product.name}</h3>
                    <div class="flex items-center mb-4">${ratingStars}<span class="ms-2 text-sm text-slate-400">(${product.rating || 0})</span></div>
                    <div class="flex items-baseline mb-4"><p class="text-3xl font-bold text-white text-left">$${product.price?.toFixed(2) || '0.00'}</p>${product.onSale && product.originalPrice ? `<p class="text-lg text-slate-500 line-through ms-2 text-left">$${product.originalPrice.toFixed(2)}</p>` : ''}</div></div>
                <div class="p-4 border-t border-slate-700 mt-auto grid grid-cols-2 gap-3"></div>`;
            const buttonContainer = card.querySelector('.grid.grid-cols-2');
            const detailsButton = createStyledButton('التفاصيل', () => navigateTo('productDetail', product), { variant: 'outline-sky', size: 'small', iconName: 'eye' });
            const buyButton = createStyledButton('شراء الآن', () => addToCart(product), { variant: 'primary', size: 'small', iconName: 'dollarSign' });
            buttonContainer.appendChild(detailsButton); buttonContainer.appendChild(buyButton);
            card.querySelectorAll('.product-details-link').forEach(el => el.addEventListener('click', () => navigateTo('productDetail', product)));
            return card;
        }

        function renderProductList(productsToRender, title = "المنتجات المميزة") {
            const container = document.createElement('div');
            container.className = "container mx-auto py-12 md:py-16 px-4";
            let titleSuffix = '';
            if (isLoadingProducts && (allProducts.length === 0 || allProducts === initialProductsData)) { // إذا كنا نعرض البيانات الأولية وما زال التحميل جاريًا
                titleSuffix = ` <span class="text-sm text-slate-400">(${getIcon('loader2', 16, 'inline-block align-middle')} جاري تحميل المزيد...)</span>`;
            }
            container.innerHTML = `<h2 class="text-3xl md:text-4xl font-bold text-white mb-10 text-center tracking-tight">${title}${titleSuffix}</h2>`;
            if (productsToRender.length === 0 && !isLoadingProducts) { // لا توجد منتجات حتى بعد التحميل
                container.innerHTML += `<p class="text-slate-400 text-center text-xl py-10">لا توجد منتجات لعرضها حاليًا.</p>`;
            } else if (productsToRender.length === 0 && isLoadingProducts) { // لا توجد منتجات أولية والتحميل جاري
                 container.innerHTML += `<div class="text-center py-10"><div class="text-slate-400 text-xl">${getIcon('loader2', 32, 'mx-auto mb-4')} جاري البحث عن كنوز رقمية...</div></div>`;
            }
            else {
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8";
                productsToRender.forEach(product => grid.appendChild(renderProductCard(product)));
                container.appendChild(grid);
            }
            return container;
        }

        function renderProductDetailView() {
            if (!selectedProduct) return `<p class="text-white p-8">المنتج غير موجود. <button id="back-to-products-btn-nf" class="text-sky-400">العودة</button></p>`;
            const ratingStars = [...Array(5)].map((_, i) => `<span class="${i < Math.round(selectedProduct.rating || 0) ? "text-yellow-400 fill-current" : "text-slate-600"}">${getIcon('star', 22)}</span>`).join('');
            const tagsHTML = selectedProduct.tags && selectedProduct.tags.length > 0 ? `<div class="mb-6 mt-8"><h4 class="text-md font-semibold text-slate-200 mb-2">الوسوم:</h4><div class="flex flex-wrap gap-2">${selectedProduct.tags.map(tag => `<span class="bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-sm shadow-sm flex items-center">${tag} ${getIcon('tag', 14, 'ms-1.5')}</span>`).join('')}</div></div>` : '';
            const viewHTML = `
                <div class="container mx-auto py-10 md:py-16 px-4 text-white">
                    <div id="back-button-container-detail" class="mb-8"></div>
                    <div class="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-10 flex flex-col lg:flex-row gap-8 md:gap-12">
                        <div class="lg:w-2/5"><img src="${selectedProduct.imageUrl || 'https://placehold.co/600x400/1a202c/718096?text=لا+توجد+صورة'}" alt="${selectedProduct.name}" class="w-full h-auto max-h-[550px] object-contain rounded-lg shadow-xl mb-4 md:mb-0 border border-slate-700" onerror="this.src='https://placehold.co/600x400/1a202c/718096?text=خطأ+في+الصورة'}"></div>
                        <div class="lg:w-3/5 flex flex-col"><div>
                            ${selectedProduct.category ? `<span class="text-sm bg-sky-600 text-sky-100 px-3 py-1 rounded-full mb-3 inline-block shadow-sm">${selectedProduct.category}</span>` : ''}
                            <h2 class="text-3xl md:text-4xl font-bold text-sky-300 mb-4 tracking-tight">${selectedProduct.name}</h2>
                            <div class="flex items-center mb-5">${ratingStars}<span class="ms-3 text-lg text-slate-300">(${selectedProduct.rating || 0} نجوم)</span></div>
                            <p class="text-slate-300 text-lg mb-6 leading-relaxed whitespace-pre-wrap">${selectedProduct.description}</p>${tagsHTML}</div>
                            <div class="mt-auto pt-6 border-t border-slate-700">
                                <div class="flex items-baseline mb-6"><p class="text-4xl font-extrabold text-white text-left">$${selectedProduct.price?.toFixed(2) || '0.00'}</p>${selectedProduct.onSale && selectedProduct.originalPrice ? `<p class="text-2xl text-slate-500 line-through ms-3 text-left">$${selectedProduct.originalPrice.toFixed(2)}</p>` : ''}</div>
                                <div id="product-detail-buttons-container" class="flex flex-col sm:flex-row gap-4"></div></div></div></div></div>`;
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = viewHTML;
            const backButtonContainer = tempDiv.querySelector('#back-button-container-detail');
            const backButton = createStyledButton('العودة إلى المنتجات', () => navigateTo('products'), { variant: 'secondary', iconName: 'arrowLeft' });
            backButtonContainer.appendChild(backButton);
            const buttonsContainer = tempDiv.querySelector('#product-detail-buttons-container');
            const addToCartBtn = createStyledButton('أضف إلى السلة', () => addToCart(selectedProduct), { variant: 'primary', size: 'large', className: 'flex-grow', iconName: 'shoppingCart' });
            buttonsContainer.appendChild(addToCartBtn);
            if (selectedProduct.demoUrl && selectedProduct.demoUrl !== "#") {
                const demoButton = createStyledButton('عرض تجريبي', () => window.open(selectedProduct.demoUrl, '_blank'), { variant: 'secondary', size: 'large', className: 'flex-grow', iconName: 'externalLink' });
                buttonsContainer.appendChild(demoButton); }
            if (document.getElementById('back-to-products-btn-nf')) { document.getElementById('back-to-products-btn-nf').addEventListener('click', () => navigateTo('products')); }
            return tempDiv.innerHTML;
        }

        function renderCartView() {
            if (isCartLoading) return `<div class="text-white text-center py-20 text-xl">${getIcon('loader2', 32, 'mx-auto mb-2')} جاري تحميل السلة...</div>`;
            const mainContainer = document.createElement('div'); mainContainer.className = "container mx-auto py-10 md:py-16 px-4 text-white";
            if (cart.items.length === 0) {
                mainContainer.innerHTML = `<div class="text-center">${getIcon('shoppingCart', 72, 'mx-auto mb-8 text-slate-500')}<h2 class="text-4xl font-semibold mb-5">سلة التسوق فارغة!</h2><p class="text-slate-400 mb-8 text-lg">لم تقم بإضافة أي كنوز رقمية بعد. ابدأ رحلة التسوق الآن!</p><div id="browse-products-btn-container"></div></div>`;
                const browseBtnContainer = mainContainer.querySelector('#browse-products-btn-container');
                const browseBtn = createStyledButton('تصفح المنتجات', () => navigateTo('products'), {variant: 'primary', size: 'large', iconName: 'search'});
                browseBtnContainer.appendChild(browseBtn); return mainContainer.innerHTML; }
            let itemsHTML = cart.items.map(item => `
                <div class="flex flex-col sm:flex-row items-center justify-between py-5 border-b border-slate-700 last:border-b-0 gap-4">
                    <div class="flex items-center w-full sm:w-2/5"><img src="${item.imageUrl || 'https://placehold.co/80x80/1a202c/718096?text=N/A'}" alt="${item.name}" class="w-24 h-24 object-cover rounded-lg ms-4 shadow-md border border-slate-700" onerror="this.src='https://placehold.co/80x80/1a202c/718096?text=N/A'}"><div><h3 class="text-lg font-semibold text-sky-300 hover:text-sky-200 cursor-pointer cart-item-name" data-product-id="${item.id}">${item.name}</h3><p class="text-sm text-slate-400 text-right">$${item.price?.toFixed(2)}</p></div></div>
                    <div class="flex items-center justify-between w-full sm:w-auto gap-3 sm:gap-5">
                        <div class="flex items-center"><button class="quantity-btn p-1.5 text-slate-400 hover:text-white transition-colors bg-slate-700 rounded-md hover:bg-slate-600" data-product-id="${item.id}" data-action="decrease">${getIcon('minusCircle', 20)}</button><span class="mx-3 text-lg font-medium w-8 text-center">${item.quantity}</span><button class="quantity-btn p-1.5 text-slate-400 hover:text-white transition-colors bg-slate-700 rounded-md hover:bg-slate-600" data-product-id="${item.id}" data-action="increase">${getIcon('plusCircle', 20)}</button></div>
                        <p class="text-lg font-semibold w-24 text-left">$${(item.price * item.quantity).toFixed(2)}</p><div class="remove-item-btn-container" data-product-id="${item.id}"></div></div></div>`).join('');
            mainContainer.innerHTML = `<h2 class="text-3xl md:text-4xl font-bold mb-10">سلة التسوق الخاصة بك</h2><div class="bg-slate-800 rounded-xl shadow-2xl p-5 md:p-8">${itemsHTML}<div class="mt-10 pt-8 border-t border-slate-700"><div class="flex justify-between items-center mb-3"><p class="text-xl text-slate-300">المجموع الفرعي:</p><p class="text-xl font-semibold text-left">$${cart.totalAmount.toFixed(2)}</p></div><div class="flex justify-between items-center mb-8"><p class="text-xl text-slate-300">إجمالي المنتجات:</p><p class="text-xl font-semibold">${cart.totalItems}</p></div><div id="cart-actions-container" class="flex flex-col sm:flex-row justify-between gap-4"></div></div></div>`;
            cart.items.forEach(item => { const removeItemContainer = mainContainer.querySelector(`.remove-item-btn-container[data-product-id="${item.id}"]`); if (removeItemContainer) { const removeBtn = createStyledButton('', () => removeFromCart(item.id), {variant: 'danger', className: 'p-2.5', iconName: 'trash2'}); removeItemContainer.appendChild(removeBtn); }});
            const cartActionsContainer = mainContainer.querySelector('#cart-actions-container');
            const clearCartBtn = createStyledButton('إفراغ السلة', clearCart, {variant: 'secondary', size: 'large'});
            const checkoutBtn = createStyledButton('المتابعة إلى الدفع', () => navigateTo('checkout'), {variant: 'success', size: 'large'});
            cartActionsContainer.appendChild(clearCartBtn); cartActionsContainer.appendChild(checkoutBtn);
            mainContainer.querySelectorAll('.quantity-btn').forEach(button => button.addEventListener('click', (e) => { const productId = e.currentTarget.dataset.productId; const action = e.currentTarget.dataset.action; const item = cart.items.find(i => i.id === productId); if (item) { updateQuantity(productId, action === 'increase' ? item.quantity + 1 : item.quantity - 1); }}));
            mainContainer.querySelectorAll('.cart-item-name').forEach(nameEl => nameEl.addEventListener('click', (e) => { const productId = e.currentTarget.dataset.productId; const product = (allProducts.length > 0 ? allProducts : initialProductsData).find(p => p.id === productId); if (product) navigateTo('productDetail', product); }));
            return mainContainer.innerHTML;
        }

        function renderCheckoutView() {
            // (منطق renderCheckoutView يبقى كما هو إلى حد كبير، فهو يعتمد على حالة السلة)
            // ... (نفس الكود السابق لـ renderCheckoutView)
            let submissionMessage = { type: '', text: '' }; 
            let isProcessing = false; 
            const storeWhatsAppNumber = "967782343232";
            const container = document.createElement('div');
            container.className = "container mx-auto py-10 md:py-16 px-4 text-white";

            function updateCheckoutView() { 
                if (submissionMessage.type === 'success' && cart.items.length === 0) {
                    container.innerHTML = `<div class="text-center">${getIcon('messageSquare', 72, 'mx-auto mb-8 text-green-400')}<h2 class="text-3xl font-semibold mb-4 text-green-300">تم تجهيز رسالة طلبك عبر واتساب!</h2><p class="text-slate-300 mb-6 text-lg">${submissionMessage.text}</p><div id="checkout-home-btn-container"></div></div>`;
                    const homeBtnContainer = container.querySelector('#checkout-home-btn-container');
                    const homeBtn = createStyledButton('العودة إلى الرئيسية', () => navigateTo('home'), {variant: 'primary', size: 'large'});
                    homeBtnContainer.appendChild(homeBtn); return; }
                if (cart.items.length === 0 && submissionMessage.type !== 'success') {
                    container.innerHTML = `<div class="text-center"><h2 class="text-2xl font-semibold mb-4">سلتك فارغة.</h2><p class="text-slate-400 mb-8">يرجى إضافة منتجات إلى سلتك قبل المتابعة إلى الدفع.</p><div id="checkout-shop-btn-container"></div></div>`;
                    const shopBtnContainer = container.querySelector('#checkout-shop-btn-container');
                    const shopBtn = createStyledButton('تسوق المنتجات', () => navigateTo('products'), {variant: 'primary', size: 'large'});
                    shopBtnContainer.appendChild(shopBtn); return; }
                const itemsSummaryHTML = cart.items.map(item => `<div class="flex justify-between items-center py-2.5 border-b border-slate-700 last:border-b-0"><div><p class="font-medium text-slate-200">${item.name} <span class="text-xs text-slate-400">(x${item.quantity})</span></p></div><p class="text-slate-300 text-left">$${(item.price * item.quantity).toFixed(2)}</p></div>`).join('');
                container.innerHTML = `
                    <h2 class="text-3xl md:text-4xl font-bold mb-10">تأكيد الطلب عبر واتساب</h2>
                    <div class="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 max-w-2xl mx-auto"><h3 class="text-2xl font-semibold mb-6 text-sky-300">ملخص الطلب</h3>${itemsSummaryHTML}
                        <div class="mt-8 pt-6 border-t border-slate-700"><div class="flex justify-between items-center text-xl font-semibold"><p class="text-slate-100">الإجمالي:</p><p class="text-white text-left">$${cart.totalAmount.toFixed(2)}</p></div></div>
                        ${submissionMessage.text && !isProcessing ? `<div class="p-4 mt-6 rounded-md text-sm flex items-center gap-3 ${submissionMessage.type === 'error' ? 'bg-red-900/50 text-red-300 border border-red-700' : 'bg-green-900/50 text-green-300 border border-green-700'}">${submissionMessage.type === 'error' ? getIcon('info', 20) : getIcon('checkCircle', 20)}<span>${submissionMessage.text}</span></div>` : ''}
                        <form id="checkout-form" class="mt-8"><p class="text-sm text-slate-400 mb-6">بالضغط على الزر أدناه، سيتم تحضير رسالة واتساب تحتوي على تفاصيل طلبك. <strong>يجب عليك إرسال هذه الرسالة يدويًا من تطبيق واتساب</strong> لإتمام عملية الطلب. يمكنك إرفاق إيصال الدفع في محادثة واتساب.</p><div id="submit-order-btn-container"></div></form></div>`;
                const submitBtnContainer = container.querySelector('#submit-order-btn-container');
                const submitBtn = createStyledButton(isProcessing ? 'جاري التجهيز...' : 'إرسال الطلب عبر واتساب', null, { type: 'submit', variant: 'whatsapp', size: 'large', className: 'w-full', disabled: isProcessing, iconName: isProcessing ? 'loader2' : 'messageSquare' });
                submitBtnContainer.appendChild(submitBtn);
                const form = container.querySelector('#checkout-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (cart.items.length === 0) { submissionMessage = {type: 'error', text: 'سلتك فارغة. يرجى إضافة منتجات أولاً.'}; updateCheckoutView(); return; }
                    isProcessing = true; submissionMessage = {type: '', text: ''}; updateCheckoutView(); 
                    const orderId = `ORDER-${Date.now()}`; let messageBody = `*طلب جديد من المتجر الأنيق* 🔥\n\n*رقم الطلب:* ${orderId}\n\n🛍️ *المنتجات المطلوبة:*\n`;
                    cart.items.forEach(item => { messageBody += `  - ${item.name} (الكمية: ${item.quantity}) - السعر: $${(item.price * item.quantity).toFixed(2)}\n`; });
                    messageBody += `\n💰 *المجموع الكلي للطلب:* $${cart.totalAmount.toFixed(2)}\n\n-------------------------------------\nالرجاء تأكيد استلام الطلب وتفعيل الخدمة. يمكنك إرسال إيصال الدفع في هذه المحادثة.\n\nشكرًا لتعاملك معنا! ✨`;
                    const encodedMessage = encodeURIComponent(messageBody); const whatsappUrl = `https://wa.me/${storeWhatsAppNumber}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank'); isProcessing = false; submissionMessage = {type: 'success', text: 'تم تجهيز طلبك للإرسال عبر واتساب. يرجى فتح تطبيق واتساب وإرسال الرسالة المجهزة لإتمام الطلب. سيتم مسح السلة الآن.'};
                    console.log("===== تم تجهيز رسالة واتساب للطلب التالي ====="); console.log("رقم الطلب:", orderId); console.log("المنتجات:", cart.items.map(item => `${item.name} (x${item.quantity})`).join(', ')); console.log("الإجمالي:", cart.totalAmount); console.log("رابط واتساب:", whatsappUrl); console.log("==========================================");
                    clearCart(); updateCheckoutView(); });
            }
            updateCheckoutView(); 
            return container.innerHTML;
        }


        function renderInfoPageLayout(title, contentHTML) { /* ... نفس الكود ... */ 
            return `
                <div class="container mx-auto py-16 px-4 text-white min-h-[calc(100vh-250px)] flex flex-col items-center">
                    <h2 class="text-4xl md:text-5xl font-bold mb-10 text-sky-300 text-center animate-fade-in-down section-title-underline">${title}</h2>
                    <div class="bg-slate-800 p-8 md:p-12 rounded-xl shadow-2xl max-w-3xl w-full mx-auto text-lg leading-relaxed animate-fade-in-up delay-200">
                        ${contentHTML}</div></div>`;
        }
        function renderAboutUsView() { const content = `<p class="mb-6 text-slate-200">أهلاً بك في <strong>المتجر الأنيق</strong>! ...</p><p class="mb-6 text-slate-200">مهمتنا هي ...</p><p class="text-slate-200">نؤمن بأهمية ...</p>`; return renderInfoPageLayout("من نحن", content); }
        function renderContactUsView() { const content = `<p class="mb-8 text-slate-200">يسعدنا تواصلك معنا! ...</p><ul class="space-y-6 mb-8"><li class="flex items-start">${getIcon('mail', 28, 'me-4 text-sky-400 mt-1 flex-shrink-0')}<div><h3 class="font-semibold text-xl text-sky-300 mb-1">البريد الإلكتروني</h3><a href="mailto:sabersaeedsaif@gmail.com" class="text-slate-200 hover:text-sky-400 transition-colors">sabersaeedsaif@gmail.com</a></div></li><li class="flex items-start">${getIcon('messageSquare', 28, 'me-4 text-sky-400 mt-1 flex-shrink-0')}<div><h3 class="font-semibold text-xl text-sky-300 mb-1">واتساب</h3><a href="https://wa.me/967782343232" target="_blank" rel="noopener noreferrer" class="text-slate-200 hover:text-sky-400 transition-colors dir-ltr inline-block">+967 782 343 232</a></div></li></ul><p class="text-slate-300">نحن متواجدون ...</p>`; return renderInfoPageLayout("اتصل بنا", content); }
        function renderPrivacyPolicyView() { const content = `<p class="mb-4">تاريخ السريان: ...</p><p class="mb-6">نحن في "المتجر الأنيق" ...</p><h3 class="text-2xl font-semibold text-sky-400 mt-6 mb-3">1. المعلومات التي نجمعها</h3>...`; return renderInfoPageLayout("سياسة الخصوصية", content); }
        function renderFAQView() {
            const faqs = [ /* ... نفس الأسئلة والأجوبة ... */ 
                { question: "كيف يمكنني شراء منتج من المتجر؟", answer: "تصفح المنتجات، أضف المنتج الذي تريده إلى سلة التسوق، ثم انتقل إلى السلة واضغط على 'المتابعة إلى الدفع'. سيتم توجيهك لإرسال تفاصيل طلبك عبر واتساب لإتمام عملية الشراء." },
                { question: "ما هي طرق الدفع المتاحة؟", answer: "حاليًا، يتم تأكيد الطلبات عبر واتساب. يمكنك مناقشة تفاصيل الدفع وإرسال الإيصال مباشرة عبر محادثة واتساب مع إدارة المتجر." },
                { question: "هل المنتجات رقمية أم مادية؟", answer: "جميع المنتجات المعروضة في المتجر هي منتجات رقمية. سيتم تسليمها لك إلكترونيًا بعد تأكيد الدفع." },
                { question: "كيف أحصل على المنتج بعد الشراء؟", answer: "بعد تأكيد طلبك ودفعك عبر واتساب، سيتم إرسال المنتج الرقمي إليك بالطريقة المتفق عليها." },
                { question: "هل يمكنني استرجاع المنتج أو استرداد المبلغ؟", answer: "نظرًا لطبيعة المنتجات الرقمية، قد تختلف سياسة الاسترجاع والاسترداد. يرجى التواصل معنا." }
            ];
            const faqItemsHTML = faqs.map((faq, index) => `<div class="border-b border-slate-700 py-4"><button class="faq-item-toggle flex justify-between items-center w-full text-right text-lg font-semibold text-sky-300 hover:text-sky-200 transition-colors" data-index="${index}"><span>${faq.question}</span><span class="faq-icon">${getIcon('chevronDown', 24)}</span></button><div class="faq-answer hidden mt-3 text-slate-300 leading-relaxed animate-fade-in-up text-base"><p>${faq.answer}</p></div></div>`).join('');
            const content = `<div class="space-y-4">${faqItemsHTML}</div>`; const pageHTML = renderInfoPageLayout("الأسئلة المتكررة", content);
            setTimeout(() => { document.querySelectorAll('.faq-item-toggle').forEach(button => button.addEventListener('click', (e) => { const answerDiv = e.currentTarget.nextElementSibling; const iconSpan = e.currentTarget.querySelector('.faq-icon'); const isOpen = !answerDiv.classList.contains('hidden'); answerDiv.classList.toggle('hidden'); iconSpan.innerHTML = isOpen ? getIcon('chevronDown', 24) : getIcon('chevronUp', 24); })); }, 0);
            return pageHTML;
        }
        
        function renderFooter() {
            const footerContainer = document.getElementById('footer-container'); if (!footerContainer) return;
            footerContainer.innerHTML = `
                <footer class="bg-slate-850 text-slate-400 py-16 mt-auto border-t border-slate-700"><div class="container mx-auto px-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10 mb-10"><div><h3 class="text-xl font-semibold text-sky-400 mb-4 flex items-center">${getIcon('zap', 24, 'me-2 text-yellow-400')}المتجر الأنيق</h3><p class="text-sm leading-relaxed">وجهتك الأولى للمنتجات الرقمية ...</p></div><div><h3 class="text-lg font-semibold text-white mb-4">روابط مهمة</h3><ul class="space-y-2.5 text-sm"><li><a href="#" data-view="about" class="footer-nav-link hover:text-sky-400 transition-colors">من نحن</a></li><li><a href="#" data-view="contact" class="footer-nav-link hover:text-sky-400 transition-colors">اتصل بنا</a></li><li><a href="#" data-view="privacy" class="footer-nav-link hover:text-sky-400 transition-colors">سياسة الخصوصية</a></li><li><a href="#" data-view="faq" class="footer-nav-link hover:text-sky-400 transition-colors">الأسئلة المتكررة</a></li></ul></div><div><h3 class="text-lg font-semibold text-white mb-4">تواصل معنا</h3><ul class="space-y-2.5 text-sm"><li><a href="mailto:sabersaeedsaif@gmail.com" class="hover:text-sky-400 transition-colors flex items-center">${getIcon('mail', 16, 'me-2')} sabersaeedsaif@gmail.com</a></li><li><a href="https://wa.me/967782343232" target="_blank" rel="noopener noreferrer" class="hover:text-sky-400 transition-colors flex items-center">${getIcon('messageSquare', 16, 'me-2')} +967 782 343 232</a></li></ul></div></div>
                    <div class="text-center text-sm border-t border-slate-700 pt-10"><p>&copy; ${new Date().getFullYear()} المتجر الأنيق. جميع الحقوق محفوظة. <span class="block sm:inline mt-1 sm:mt-0">تصميم وتطوير لأغراض العرض.</span></p>${typeof __app_id !== 'undefined' ? `<p class="text-xs mt-2 opacity-70">معرف التطبيق: ${appId}</p>` : ''}</div></div></footer>`;
            document.querySelectorAll('.footer-nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.target.dataset.view); }));
        }

        // --- الدالة الرئيسية لعرض التطبيق ---
        function renderApp() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            renderNavbar(); // تحديث الشريط العلوي دائمًا (مهم لعدد عناصر السلة)

            if (error && (allProducts.length === 0 || allProducts === initialProductsData)) { 
                mainContent.innerHTML = `<div class="text-red-400 text-center py-20 text-xl bg-red-900/30 p-4 rounded-md max-w-2xl mx-auto my-10">${error}</div>`;
                return;
            }
            
            let viewHTML = '';
            switch (currentView) {
                case 'home':
                    viewHTML = renderPromotionalBanner();
                    viewHTML += renderHero();
                    const homePage = document.createElement('div');
                    homePage.innerHTML = viewHTML;
                    const heroButtonContainer = homePage.querySelector('#hero-button-container');
                    if(heroButtonContainer){
                        const heroButton = createStyledButton('استكشف الإبداعات الآن', () => navigateTo('products'), { variant: 'primary', size: 'large', className: 'animate-bounce-slow group shadow-sky-500/40 hover:shadow-sky-500/60', iconName: 'arrowRight' });
                        heroButtonContainer.appendChild(heroButton);
                    }
                    // استخدام البيانات الأولية إذا كانت البيانات الفعلية لا تزال تُحمّل
                    const productsForHome = (allProducts.length > 0 ? filteredProducts : initialProductsData).slice(0, 4);
                    homePage.appendChild(renderProductList(productsForHome, "أحدث الإضافات الإبداعية"));
                    mainContent.innerHTML = homePage.innerHTML;
                    break;
                case 'products':
                    const productsPage = document.createElement('div');
                    productsPage.innerHTML = renderPromotionalBanner();
                    const productsForProductPage = allProducts.length > 0 ? filteredProducts : initialProductsData;
                    productsPage.appendChild(renderProductList(productsForProductPage, "جميع كنوزنا الرقمية"));
                    mainContent.innerHTML = productsPage.innerHTML;
                    break;
                case 'productDetail':
                    if (isLoadingProducts && !selectedProduct) { 
                        mainContent.innerHTML = `<div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] text-white text-center py-20 text-xl">${getIcon('loader2', 48, 'mb-4 text-sky-400')}جاري تحميل بيانات المنتج...</div>`;
                    } else if (!selectedProduct && !isLoadingProducts) { 
                        mainContent.innerHTML = `<p class="text-white p-8">المنتج المطلوب غير موجود. <button id="back-to-products-btn-detail-nf" class="text-sky-400">العودة إلى المنتجات</button></p>`;
                        setTimeout(() => { const btn = document.getElementById('back-to-products-btn-detail-nf'); if(btn) btn.addEventListener('click', () => navigateTo('products')); },0);
                    } else { 
                        mainContent.innerHTML = renderProductDetailView();
                    }
                    break;
                case 'cart': mainContent.innerHTML = renderCartView(); break;
                case 'checkout': mainContent.innerHTML = renderCheckoutView(); break;
                case 'about': mainContent.innerHTML = renderAboutUsView(); break;
                case 'contact': mainContent.innerHTML = renderContactUsView(); break;
                case 'privacy': mainContent.innerHTML = renderPrivacyPolicyView(); break;
                case 'faq': mainContent.innerHTML = renderFAQView(); break;
                default:
                    mainContent.innerHTML = `<h2 class="text-white text-center py-20 text-2xl">الصفحة المطلوبة غير موجودة.</h2>`;
            }
            
            // إعادة ربط الأحداث للعناصر الديناميكية مثل عناصر البانر الترويجي
            document.querySelectorAll('.promotional-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const prodId = e.currentTarget.dataset.productId;
                    const product = (allProducts.length > 0 ? allProducts : initialProductsData).find(p => p.id === prodId);
                    if (product) navigateTo('productDetail', product);
                });
            });
        }
        
        // --- تهيئة التطبيق ---
        async function initializeAppLogic() {
            onAuthStateChanged(auth, async (user) => {
                isCartLoading = true; 
                if (unsubscribeCartListener) { unsubscribeCartListener(); unsubscribeCartListener = null; }
                if (user) {
                    userId = user.uid;
                    const cartDocRef = doc(db, `/artifacts/${appId}/users/${userId}/cart/userCart_ar`);
                    unsubscribeCartListener = onSnapshot(cartDocRef, async (docSnap) => {
                        if (docSnap.exists()) { cart = docSnap.data(); } 
                        else { const newCartData = { items: [], totalAmount: 0, totalItems: 0 }; cart = newCartData; await setDoc(cartDocRef, newCartData); }
                        isCartLoading = false; renderApp(); 
                    }, (error) => { console.error("خطأ في جلب السلة:", error); cart = { items: [], totalAmount: 0, totalItems: 0 }; isCartLoading = false; renderApp(); });
                } else {
                    userId = null; cart = { items: [], totalAmount: 0, totalItems: 0 }; isCartLoading = false; 
                    renderApp(); // عرض التطبيق حتى لو لم يكن المستخدم مسجلاً (سلة فارغة)
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                else { await signInAnonymously(auth); }
            } catch (error) { 
                console.error("خطأ في مصادقة Firebase:", error); 
                self.error = "فشلت المصادقة."; isCartLoading = false; 
                // لا يزال يجب عرض التطبيق حتى لو فشلت المصادقة، مع إمكانية عرض رسالة خطأ إذا لزم الأمر
                renderApp(); 
            }
            
            await fetchProducts(); // جلب المنتجات بعد محاولة تسجيل الدخول
        }

        // بدء التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            renderNavbar(); // عرض الشريط العلوي فورًا
            renderFooter(); // عرض التذييل فورًا
            
            // عرض مبدئي للصفحة الرئيسية باستخدام البيانات الأولية
            currentView = 'home'; 
            filterProducts(); // فلترة البيانات الأولية إذا كان هناك بحث مبدئي (عادة لا يوجد)
            renderApp(); 
            
            initializeAppLogic(); // بدء تحميل البيانات من Firebase والمصادقة
            
            document.addEventListener('navigateTo', (event) => { 
                navigateTo(event.detail.view, event.detail.product);
            });
        });

    </script>
    <style>
        body { font-family: 'Tajawal', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html { scroll-behavior: smooth; }
        @keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-25px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fade-in-down 0.6s ease-out forwards; }
        @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(25px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
        .delay-200 { animation-delay: 0.2s; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-4%); animation-timing-function: cubic-bezier(0.8,0,1,1); } 50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); } }
        .animate-bounce-slow { animation: bounce-slow 2.5s infinite; }
        .bg-slate-850 { background-color: #161e2c; } 
        .pattern-dots { background-image: radial-gradient(currentColor 1px, transparent 1px); background-size: calc(10 * 1px) calc(10 * 1px); }
        .marquee-container { width: 100%; overflow: hidden; }
        .marquee-content { display: flex; width: max-content; }
        @keyframes marquee { 0% { transform: translateX(0%); } 100% { transform: translateX(-50%); } }
        .animate-marquee { animation: marquee 40s linear infinite; }
        .marquee-content:hover { animation-play-state: paused; }
        .section-title-underline { position: relative; padding-bottom: 0.75rem; }
        .section-title-underline::after { content: ''; position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: 80px; height: 4px; background-color: #0ea5e9; border-radius: 3px; }
        input[type="text"]::placeholder { color: #64748b; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-pulse-slower { animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col text-slate-100">
    <div id="navbar-container"></div>
    <main id="main-content" class="flex-grow transition-opacity duration-500 ease-in-out"></main>
    <div id="footer-container"></div>
</body>
</html>
